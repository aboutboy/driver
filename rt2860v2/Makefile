# All rights reserved.
#

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=rt2860v2
# PKG_VERSION:=1

PKG_KCONFIG_COMMON:= \
RALINK_MT7628 RALINK_MT7621 RALINK_MT7620 RALINK_RT3883  RALINK_RT5350 RALINK_RT3352 RALINK_RT3052 \
RT_FIRST_IF_NONE RT_FIRST_IF_RT2860  RT_FIRST_IF_MT7620  RT_FIRST_IF_MT7628 RT_FIRST_IF_RT3090 \
RT_FIRST_IF_RT5392 RT_FIRST_IF_RT5592 RT_FIRST_IF_RT3593 RT_FIRST_IF_MT7610E  RT_FIRST_IF_MT7602E \
RT_FIRST_IF_MT7612E  RT_FIRST_IF_MT7603E RT_FIRST_IF_MT7615E RT_FIRST_IF_RANGE_2GHZ \
RT_FIRST_IF_RANGE_5GHZ RT_FIRST_IF_EEPROM_FLASH RT_FIRST_IF_EEPROM_EFUSE RT_FIRST_IF_EEPROM_PROM \
RT_FIRST_IF_RF_OFFSET RT_FIRST_CARD RT_FIRST_CARD_EEPROM  RT_SECOND_IF_NONE \
RT_SECOND_IF_RT3352_INIC RT_SECOND_IF_RT3090  RT_SECOND_IF_RT5392 RT_SECOND_IF_RT5592 \
RT_SECOND_IF_RT3593 RT_SECOND_IF_MT7610E RT_SECOND_IF_MT7602E RT_SECOND_IF_MT7612E \
RT_SECOND_IF_MT7603E RT_SECOND_IF_MT7615E RT_SECOND_IF_RANGE_2GHZ RT_SECOND_IF_RANGE_5GHZ \
SECOND_IF_EEPROM_FLASH SECOND_IF_EEPROM_EFUSE SECOND_IF_EEPROM_PROM \
RT_SECOND_IF_RF_OFFSET RT_SECOND_CARD RT_SECOND_CARD_EEPROM RALINK_RT5350_1T1R \
RALINK_RT3050_1T1R RALINK_RT3051_1T2R RALINK_RT3052_2T2R RALINK_RT3352  RALINK_RT3352_2T2R \
RALINK_RT3662_2T2R RALINK_RT3883_3T3R  \
RT_SINGLE_SKU RT_MAX_CLIENTS  RT_BAND_STEERING RT_DOT11R_FT RT_DOT11K_RRM RT_80211N_DRAFT3 \
RT_80211W_PMF RT_WAPI RT_WSC RT_WSC_V2 RT_WSC_NFC RT_ED_MONITOR RT_IGMP_SNOOP \
RT_MCAST_RATE_SPECIFIC RT_DELAYED_TCP_ACK  RT_HDR_TRANS RT_CSO RT_NETIF_BLOCK \
RT_VIDEO_TURBINE RT_SNMP RT_CFG80211 RT_READ_MAC_FROM_MTD RT_MEMORY_OPTIMIZATION RT_BIG_ENDIAN \
RT_MC_SUPPORT RT_BRIDGE_FASTPATH RT_ATE RT_QA RT_DEBUG 

PKG_KCONFIG:= $(PKG_KCONFIG_COMMON) \
RT2860V2_AP RT2860V2_AP_LED RT2860V2_AP_LED_SOFT RT2860V2_AP_LED_SOFT_GPIO \
RT2860V2_AP_LLTD RT2860V2_AP_WDS RT2860V2_AP_MBSS RT2860V2_AP_MBSS_NEW_MBSSID_MODE \
RT2860V2_AP_APCLI RT2860V2_AP_MAC_REPEATER RT2860V2_AP_DFS \
RT2860V2_AP_CARRIER RT2860V2_AP_DLS RT2860V2_AP_IDS RT2860V2_AP_ANTENNA_DIVERSITY \
RT2860V2_AP_GREENAP RT2860V2_AP_TXBF INTERNAL_PA_INTERNAL_LNA INTERNAL_PA_EXTERNAL_LNA \
EXTERNAL_PA_EXTERNAL_LNA RT2860V2_AP_RTMP_INTERNAL_TX_ALC RT2860V2_AP_RTMP_TEMPERATURE_COMPENSATION \
RT2860V2_AP_ADJ_PWR_CONSUMPTION NF_SYS_EVENT_NETLINK

PKG_CONFIG_DEPENDS:=$(foreach c,$(PKG_KCONFIG),$(if $(CONFIG_$c),CONFIG_$(c)))

include $(INCLUDE_DIR)/package.mk

define KernelPackage/rt2860v2
  CATEGORY:=Ralink
  TITLE:=Ralink RT2860v2 AP driver
  FILES:=$(PKG_BUILD_DIR)/rt2860v2_ap/rt2860v2_ap.ko
  AUTOLOAD:=$(call AutoLoad,30,rt2860v2_ap)
  MENU:=1
endef

define KernelPackage/rt2860v2/config
	source "$(SOURCE)/Config-rt2860v2.in"
endef

define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
	$(CP) ./src/* $(PKG_BUILD_DIR)/
	$(call Build/Prepare/Default)
endef

NOSTDINC_FLAGS = \
	-I$(LINUX_DIR)/net/nat/hw_nat/ 
	
define Build/Compile
	$(MAKE) -C "$(LINUX_DIR)" \
		CROSS_COMPILE="$(TARGET_CROSS)" \
		ARCH="$(LINUX_KARCH)" \
		RT_DRV_DIR="$(PKG_BUILD_DIR)/rt2860v2" \
		RT_DRV_PATH="../rt2860v2/" \
		RT_DRV_NAME="rt2860v2_ap" \
		NOSTDINC_FLAGS="$(NOSTDINC_FLAGS)" \
		SUBDIRS="$(PKG_BUILD_DIR)/rt2860v2_ap/" \
		$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_$c),CONFIG_$(c)=$(CONFIG_$c)))\
		modules
endef

define KernelPackage/rt2860v2/install
# 	$(INSTALL_DIR) $(1)/lib/wifi
# 	$(INSTALL_DIR) $(1)/etc_ro/Wireless/
# 	$(INSTALL_DATA) ./files/MT7628_EEPROM.bin $(1)/etc_ro/Wireless/
	echo -------------------------------------------------------------------$(CONFIG_RT_FIRST_CARD) $(CONFIG_RT_SECOND_CARD)

endef

$(eval $(call KernelPackage,rt2860v2))
