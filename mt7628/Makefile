# All rights reserved.
#

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=mt7628
# PKG_VERSION:=1

PKG_KCONFIG_COMMON:= \
RALINK_MT7628 RALINK_MT7621 RALINK_MT7620 RALINK_RT3883  RALINK_RT5350 RALINK_RT3352 RALINK_RT3052 \
RT_FIRST_IF_NONE RT_FIRST_IF_RT2860  RT_FIRST_IF_MT7620  RT_FIRST_IF_MT7628 RT_FIRST_IF_RT3090 \
RT_FIRST_IF_RT5392 RT_FIRST_IF_RT5592 RT_FIRST_IF_RT3593 RT_FIRST_IF_MT7610E  RT_FIRST_IF_MT7602E \
RT_FIRST_IF_MT7612E  RT_FIRST_IF_MT7603E RT_FIRST_IF_MT7615E RT_FIRST_IF_RANGE_2GHZ \
RT_FIRST_IF_RANGE_5GHZ RT_FIRST_IF_EEPROM_FLASH RT_FIRST_IF_EEPROM_EFUSE RT_FIRST_IF_EEPROM_PROM \
RT_FIRST_IF_RF_OFFSET RT_FIRST_CARD RT_FIRST_CARD_EEPROM  RT_SECOND_IF_NONE \
RT_SECOND_IF_RT3352_INIC RT_SECOND_IF_RT3090  RT_SECOND_IF_RT5392 RT_SECOND_IF_RT5592 \
RT_SECOND_IF_RT3593 RT_SECOND_IF_MT7610E RT_SECOND_IF_MT7602E RT_SECOND_IF_MT7612E \
RT_SECOND_IF_MT7603E RT_SECOND_IF_MT7615E RT_SECOND_IF_RANGE_2GHZ RT_SECOND_IF_RANGE_5GHZ \
SECOND_IF_EEPROM_FLASH SECOND_IF_EEPROM_EFUSE SECOND_IF_EEPROM_PROM \
RT_SECOND_IF_RF_OFFSET RT_SECOND_CARD RT_SECOND_CARD_EEPROM RALINK_RT5350_1T1R \
RALINK_RT3050_1T1R RALINK_RT3051_1T2R RALINK_RT3052_2T2R RALINK_RT3352  RALINK_RT3352_2T2R \
RALINK_RT3662_2T2R RALINK_RT3883_3T3R  \
RT_SINGLE_SKU RT_MAX_CLIENTS  RT_BAND_STEERING RT_DOT11R_FT RT_DOT11K_RRM RT_80211N_DRAFT3 \
RT_80211W_PMF RT_WAPI RT_WSC RT_WSC_V2 RT_WSC_NFC RT_ED_MONITOR RT_IGMP_SNOOP \
RT_MCAST_RATE_SPECIFIC RT_DELAYED_TCP_ACK  RT_HDR_TRANS RT_CSO RT_NETIF_BLOCK \
RT_VIDEO_TURBINE RT_SNMP RT_CFG80211 RT_READ_MAC_FROM_MTD RT_MEMORY_OPTIMIZATION RT_BIG_ENDIAN \
RT_MC_SUPPORT RT_ATE RT_QA RT_DEBUG 

PKG_KCONFIG:= $(PKG_KCONFIG_COMMON) \
MT7628_AP MT7628_AP_LED  MT7628_AP_LED_SOFT MT7628_AP_LED_SOFT_GPIO MT7628_AP_LLTD \
MT7628_AP_WDS MT7628_AP_MBSS MT7628_AP_APCLI MT7628_AP_APCLI_AUTO_BW MT7628_AP_APCLI_CERT \
MT7628_AP_MULTI_APCLI MT7628_AP_MAC_REPEATER MT7628_AP_AIRPLAY  MT7628_AP_DFS \
MT7628_AP_CARRIER MT7628_AP_SMART_CARRIER_SENSE MT7628_AP_GREENAP MT7628_AP_IDS MT7628_AP_DLS 

PKG_CONFIG_DEPENDS:=$(foreach c,$(PKG_KCONFIG),$(if $(CONFIG_$c),CONFIG_$(c)))

include $(INCLUDE_DIR)/package.mk

define KernelPackage/mt7628
  CATEGORY:=Ralink
  TITLE:=Ralink mt7628 wifi AP driver
  FILES:=$(PKG_BUILD_DIR)/mt7628_ap/rt2860v2_ap.ko
  AUTOLOAD:=$(call AutoLoad,91,rt2860v2_ap)
#   SUBMENU:=Drivers
  MENU:=1
endef

define KernelPackage/mt7628/config
	source "$(SOURCE)/Config-mt7628.in"
endef

define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
	$(CP) ./src/* $(PKG_BUILD_DIR)/
	$(call Build/Prepare/Default)
endef

define Build/Compile
	$(MAKE) -C "$(LINUX_DIR)" \
		CROSS_COMPILE="$(TARGET_CROSS)" \
		ARCH="$(LINUX_KARCH)" \
		RT_DRV_DIR="$(PKG_BUILD_DIR)/mt7628" \
		RT_DRV_PATH="../mt7628/embedded" \
		RT_DRV_NAME="rt2860v2_ap" \
		SUBDIRS="$(PKG_BUILD_DIR)/mt7628_ap/" \
		$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_$c),CONFIG_$(c)=$(CONFIG_$c)))\
		modules
endef

define KernelPackage/mt7628/install
# 	$(INSTALL_DIR) $(1)/lib/wifi
	$(INSTALL_DIR) $(1)/etc_ro/Wireless/
	$(INSTALL_DATA) ./files/MT7628_EEPROM.bin $(1)/etc_ro/Wireless/
	echo -------------------------------------------------------------------$(CONFIG_RT_FIRST_CARD) $(CONFIG_RT_SECOND_CARD)

endef

$(eval $(call KernelPackage,mt7628))
